<?php
include 'db1.php';

$student_id = $_SESSION['id'];
$importantSubmissions = [];
$recentSubmissions = [];
$upcomingReminders = [];

if ($_SESSION['identity'] === 'Student') {
    // Important submissions (graded or late)
    $sql = "SELECT id, assessment_id, submitted_at, mark 
            FROM submissions 
            WHERE student_id = ? 
            AND (submitted_at > (SELECT deadline FROM files WHERE id = submissions.assessment_id) OR mark IS NOT NULL)
            ORDER BY submitted_at DESC 
            LIMIT 3";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$student_id]);
    $importantSubmissions = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    // Recent submissions
    $sql = "SELECT id, assessment_id, submitted_at, mark 
            FROM submissions 
            WHERE student_id = ? 
            ORDER BY submitted_at DESC 
            LIMIT 3";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$student_id]);
    $recentSubmissions = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    // Upcoming reminders (submissions due soon but not submitted yet)
    $sql = "SELECT id FROM files 
            WHERE file_type = 'assessment' 
            AND deadline BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL 7 DAY)
            AND id NOT IN (SELECT assessment_id FROM submissions WHERE student_id = ?)";
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$student_id]);
    $upcomingReminders = $stmt->fetchAll(PDO::FETCH_ASSOC);
}
?>

<div class="Activity Stream">
    <div class="Activity">
        <h2>Activity Stream</h2>
    </div>
    
    <div class="activity-section" id="activity-stream">
        <table style="width: 100%; border-collapse: collapse;">
            <!-- Important Submissions -->
            <tr>
                <th colspan="3"><header><h3><p align="left">Important</p></h3></header></th>
            </tr>
            <tr><td colspan="3"><hr></td></tr>
            <?php if (!empty($importantSubmissions)): ?>
                <?php foreach ($importantSubmissions as $sub): ?>
                    <tr>
                        <td>Assessment <?= htmlspecialchars($sub['assessment_id']) ?></td>
                        <td>
                            <?php if ($sub['mark'] !== null): ?>
                                Graded: <?= htmlspecialchars($sub['mark']) ?>
                            <?php else: ?>
                                <p style="color: red;"> Submitted late </p>
                            <?php endif; ?>
                        </td>
                        <td><?= htmlspecialchars($sub['submitted_at']) ?></td>
                    </tr>
                <?php endforeach; ?>
            <?php else: ?>
                <tr><td colspan="3" style="padding: 10px; text-align: center;">No important submissions</td></tr>
            <?php endif; ?>
            
            <!-- Recent Submissions -->
            <tr>
                <th colspan="3"><header><h3><p align="left">Recent Activity</p></h3></header></th>
            </tr>
            <tr><td colspan="3"><hr></td></tr>
            <?php if (!empty($recentSubmissions)): ?>
                <?php foreach ($recentSubmissions as $sub): ?>
                    <tr>
                        <td>Assessment <?= htmlspecialchars($sub['assessment_id']) ?></td>
                        <td>
                            <?php if ($sub['mark'] !== null): ?>
                                Mark: <?= htmlspecialchars($sub['mark']) ?>
                            <?php else: ?>
                                Submitted (pending)
                            <?php endif; ?>
                        </td>
                        <td><?= htmlspecialchars($sub['submitted_at']) ?></td>
                    </tr>
                <?php endforeach; ?>
            <?php else: ?>
                <tr><td colspan="3" style="padding: 10px; text-align: center;">No recent activity</td></tr>
            <?php endif; ?>
            
            <!-- Upcoming Reminders -->
            <tr>
                <th colspan="3"><header><h3><p align="left">Upcoming</p></h3></header></th>
            </tr>
            <tr><td colspan="3"><hr></td></tr>
            <?php if (!empty($upcomingReminders)): ?>
                <?php foreach ($upcomingReminders as $reminder): ?>
                    <tr>
                        <td colspan="3">Assessment <?= htmlspecialchars($reminder['id']) ?> due soon</td>
                    </tr>
                <?php endforeach; ?>
            <?php else: ?>
                <tr><td colspan="3" style="padding: 10px; text-align: center;">No upcoming deadlines</td></tr>
            <?php endif; ?>
        </table>
    </div>
</div>